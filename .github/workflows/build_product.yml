name: Release Build product

on:
  workflow_dispatch:
    inputs:
      TOOLCHAINS:
        type: choice
        description: "‰ΩøÁî®ÁöÑÂ∑•ÂÖ∑Èìæ"
        required: true
        default: "stable"
        options:
          - "nightly"
          - "stable"
      TARGET:
        type: choice
        description: "ÁºñËØëÁöÑÁõÆÊ†á‰∏âÂÖÉÁªÑ"
        required: true
        default: "x86_64-unknown-linux-gnu"
        options:
          - "aarch64-linux-android"
          - "x86_64-unknown-linux-gnu"
          - "aarch64-unknown-linux-gnu"
          - "x86_64-unknown-linux-musl"
          - "aarch64-unknown-linux-musl"
          - "x86_64-pc-windows-msvc"
          - "aarch64-pc-windows-msvc"
          - "aarch64-apple-darwin"
          - "x86_64-apple-darwin"

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Optimize build performance
  CARGO_INCREMENTAL: 0
  TZ: Asia/Shanghai

jobs:
  # Build strategy check - determine build type based on trigger
  build-check:
    name: Build Strategy Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Debug Show Selected Inputs
        run: |
          echo "-----------------------"
          echo "Selected TOOLCHAINS: ${{ github.event.inputs.TOOLCHAINS }}"
          echo "Selected TARGET: ${{ github.event.inputs.TARGET }}"
          echo "-----------------------"

  # Build binaries
  build-common:
    name: Build common
    needs: [build-check]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        include:
          # Platform builds
          - os: ${{ contains(github.event.inputs.TARGET, 'windows') && 'windows' || (contains(github.event.inputs.TARGET, 'apple') && 'macos' || 'ubuntu') }}-${{ contains(github.event.inputs.TARGET, 'linux') && '24.04' || contains(github.event.inputs.TARGET, 'apple') && 'latest' || contains(github.event.inputs.TARGET, 'aarch64') && '11' || 'latest' }}${{ contains(github.event.inputs.TARGET, 'aarch64') && !contains(github.event.inputs.TARGET, 'apple') && !contains(github.event.inputs.TARGET, 'android') && '-arm' || '' }}
            target: ${{ github.event.inputs.TARGET }}
    steps:
      - name: "üíæ Checkout repository"
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: "‚öôÔ∏è show Cargo config"
        if: runner.os == 'Linux'
        shell: bash
        run: |
          [ -f ~/.cargo/config.toml ] && cat ~/.cargo/config.toml || echo "cfg not found"

      - name: "üöÄ Setup Rust environment"
        uses: ./.github/actions/setup
        with:
          rust-version: ${{ github.event.inputs.TOOLCHAINS }}
          target: ${{ matrix.target }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "‚öôÔ∏è Configure Git"
        shell: bash
        run: |
          git config --global user.name "reigadegr_action"
          git config --global user.email "1145141919810@qq.com"

      - name: Setup ndk and cargo ndk
        if: runner.os == 'Linux'
        run: |
          ndk_url=$(wget -qO- https://github.com/android/ndk/releases/latest | grep -e 'https://dl.google.com/android/repository/android-ndk-.*-linux.zip' | sed -n 's/.*<a href="\([^"]*\)".*/\1/p')
          wget -O ndk.zip $ndk_url -nv
          mkdir ~/ndk_temp
          unzip ndk.zip -d ~/ndk_temp 2>&1 > /dev/null
          mv ~/ndk_temp/*/* ~/ndk_temp
          wget https://github.com/reigadegr/thread-opt_builder/raw/main/libbinder_ndk.so
          cp -f libbinder_ndk.so ~/ndk_temp/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/35/libbinder_ndk.so
          cargo install cargo-ndk

      - name: "üîß Setup TimeZone"
        if: runner.os == 'Linux'
        run: |
          sudo -E rm -rf /etc/localtime
          sudo -E ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

      - name: Optimize Memory Management
        if: runner.os == 'Linux'
        run: |
          wget https://github.com/reigadegr/sun_action/raw/main/script/memopt.sh
          nohup sh memopt.sh >/dev/null 2>&1 &

      - name: Install Zig
        if: runner.os == 'Linux'
        uses: mlugg/setup-zig@v2
        
      - uses: rui314/setup-mold@v1
        if: runner.os == 'Linux'
        with:
          mold-version: 2.40.4
          make-default: false

      - name: Install cargo-zigbuild
        if: runner.os == 'Linux'
        shell: bash
        run: |
          git clone --depth 1 https://github.com/rust-cross/cargo-zigbuild
          cd cargo-zigbuild
          cargo add mimalloc --features no_thp,override
          wget https://github.com/reigadegr/rust_cli_action/raw/main/patchs/zigbuild_mimalloc.patch
          patch -p2 -F 3 < zigbuild_mimalloc.patch
          cargo update
          cargo build -r
          dd if=target/release/cargo-zigbuild of=./cargo-zigbuild
          rm -rf target
          sudo -E cp -af ./cargo-zigbuild ~/.cargo/bin/cargo-zigbuild
          sudo -E chmod +x ~/.cargo/bin/cargo-zigbuild
          ls ~/.cargo/bin
          which cargo-zigbuild || true
          cd  ..; rm -rf cargo-zigbuild

      - name: "üì• Download github project code"
        shell: bash
        run: |
          git clone --depth 1 https://github.com/openai/codex common
          cd common
          wget https://github.com/reigadegr/codex_action/raw/main/patchs/mimalloc.patch
          patch -p1 -F 3 < mimalloc.patch
          wget https://github.com/reigadegr/codex_action/raw/main/patchs/rm_openssl.patch
          patch -p1 -F 3 < rm_openssl.patch
          version="$(git ls-remote --tags https://github.com/openai/codex.git | grep -oE 'rust-v[0-9]+\.[0-9]+\.[0-9]+$' | sed 's/rust-v//' | sort -Vr | head -1)"
          sed -i "s/0.0.0/$version/g" codex-rs/Cargo.toml
          cat codex-rs/Cargo.toml
          rm -f codex-rs/rust-toolchain.toml
          cd codex-rs; cargo add mimalloc --features no_thp,override -p codex-cli; cd  ..
          mv codex-rs ../
          cd ..
          rm -rf common
          mv codex-rs common

      - name: "‚öôÔ∏è Reset flags"
        shell: bash
        run: |
          cd common
          mkdir -p .cargo/ || true
          curl -L https://github.com/reigadegr/codex_action/raw/main/.cargo/config.toml -o .cargo/config2.toml
          cat .cargo/config2.toml >> .cargo/config.toml
          rm -f .cargo/config2.toml

      - name: "üî® Build common"
        shell: bash
        run: |
          cd common
          toolchain="${{ github.event.inputs.TOOLCHAINS }}"
          platform="${{ contains(github.event.inputs.TARGET, 'windows') && 'windows' || (contains(github.event.inputs.TARGET, 'apple') && 'apple' || contains(github.event.inputs.TARGET, 'android') && 'android' || 'linux') }}"
          script_file="build_"$toolchain"_"$platform".sh"

          url="https://github.com/reigadegr/codex_action/raw/main/script/$script_file"
          echo "ËÑöÊú¨Áõ¥Èìæ: $url"
          curl -L $url -o "$script_file"
          cat "$script_file"; ls -al
          is_musl="${{ contains(github.event.inputs.TARGET, 'musl') && 'true' || 'false' }}"
          if [ "$is_musl" = "true" ]; then
              sed -i 's/relocation-model=pie/relocation-model=static/g' "$script_file"
              sed -i 's/ build / zigbuild /g' "$script_file"
              sed -i 's/,--relax//g' "$script_file"
              sed -i 's/--pack-dyn-relocs=relr,//g' "$script_file"
              sed -i '/--no-rosegment/d' "$script_file"
          fi
          
          for i in "codex"; do
              bin_name="$i"
              sh "$script_file" "${{ matrix.target }}" "$bin_name" || true
    
              is_windows="${{ contains(github.event.inputs.TARGET, 'windows') && 'true' || 'false' }}"
              if [ "$is_windows" = "true" ]; then
                  bin_name=$bin_name.exe
              fi
              file="$(find . -name "$bin_name")"
              echo "$(realpath $file)"
              mkdir -p ../${{ github.event.inputs.TARGET }}_module || echo "Â∑≤ÊúâÈªòËÆ§ÁõÆÂΩï"
              dd if=./target/"${{ matrix.target }}"/release/$bin_name of=../"${{ matrix.target }}"_module/$bin_name
          done
          
          git log > ../"${{ matrix.target }}"_module/commits.txt

      - name: "üì§ Upload to GitHub artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.TARGET }}_codex
          path: ${{ matrix.target }}_module/*
          retention-days: 3
